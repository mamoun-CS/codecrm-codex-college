# ============================================
# POSTGRESQL PERFORMANCE CONFIGURATION
# ============================================
# Optimized for CRM backend with 10,000+ concurrent users
# 
# HARDWARE ASSUMPTIONS:
# - 16GB RAM
# - 4 CPU cores
# - SSD storage
#
# ADJUST VALUES based on your actual hardware
# ============================================

# ============================================
# MEMORY SETTINGS
# ============================================

# Shared memory for caching data
# Rule: 25% of total RAM
shared_buffers = 4GB

# Memory for complex sorts and hash tables
# Rule: 25% of RAM / max_connections
work_mem = 16MB

# Memory for maintenance operations (VACUUM, CREATE INDEX)
maintenance_work_mem = 1GB

# Effective cache size (OS + PostgreSQL cache)
# Rule: 75% of total RAM
effective_cache_size = 12GB

# ============================================
# QUERY PLANNER
# ============================================

# Cost of random page fetch
# Lower for SSD (default: 4.0)
random_page_cost = 1.1

# Cost of sequential page fetch
seq_page_cost = 1.0

# Planner's assumption about effective cache
effective_io_concurrency = 200

# ============================================
# WRITE AHEAD LOG (WAL)
# ============================================

# WAL buffer size
wal_buffers = 16MB

# Checkpoint settings
checkpoint_completion_target = 0.9
max_wal_size = 4GB
min_wal_size = 1GB

# WAL writer delay
wal_writer_delay = 200ms

# ============================================
# CONNECTION SETTINGS
# ============================================

# Maximum number of connections
# Should match or exceed backend pool max
max_connections = 200

# Superuser reserved connections
superuser_reserved_connections = 3

# ============================================
# BACKGROUND WRITER
# ============================================

# Background writer delay
bgwriter_delay = 200ms

# Maximum pages to write per round
bgwriter_lru_maxpages = 100

# Multiplier for average buffer usage
bgwriter_lru_multiplier = 2.0

# ============================================
# AUTOVACUUM
# ============================================

# Enable autovacuum
autovacuum = on

# Maximum autovacuum workers
autovacuum_max_workers = 3

# Naptime between runs
autovacuum_naptime = 1min

# Vacuum threshold
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1

# Analyze threshold
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# ============================================
# LOGGING
# ============================================

# Log slow queries
log_min_duration_statement = 500  # Log queries > 500ms

# Log connections and disconnections
log_connections = on
log_disconnections = on

# Log lock waits
log_lock_waits = on

# Log checkpoints
log_checkpoints = on

# Log autovacuum
log_autovacuum_min_duration = 0

# ============================================
# STATISTICS
# ============================================

# Enable query statistics
shared_preload_libraries = 'pg_stat_statements'

# Track query statistics
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# Track IO timing
track_io_timing = on

# Track activity query size
track_activity_query_size = 2048

# ============================================
# PARALLEL QUERY
# ============================================

# Maximum parallel workers per query
max_parallel_workers_per_gather = 2

# Maximum parallel workers for maintenance
max_parallel_maintenance_workers = 2

# Maximum parallel workers total
max_parallel_workers = 4

# ============================================
# LOCKS
# ============================================

# Maximum locks per transaction
max_locks_per_transaction = 64

# Deadlock timeout
deadlock_timeout = 1s

# ============================================
# STATEMENT TIMEOUT
# ============================================

# Maximum statement execution time (0 = disabled)
# Set in application instead for better control
statement_timeout = 0

# Idle in transaction timeout
idle_in_transaction_session_timeout = 60000  # 60 seconds

# ============================================
# LOCALE AND FORMATTING
# ============================================

# Timezone
timezone = 'UTC'

# Date style
datestyle = 'iso, mdy'

# Locale
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search config
default_text_search_config = 'pg_catalog.english'

